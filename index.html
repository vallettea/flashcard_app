<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Flashcard App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        section { margin-bottom: 20px; }
        button { margin-right: 10px; }
        ul { list-style: none; padding: 0; }
        li { margin-bottom: 10px; border: 1px solid #ddd; padding: 10px; }
        .group-item { cursor: move; }
        .flashcard { border: 1px solid #000; padding: 20px; text-align: center; min-height: 200px; }
        .front, .back { display: none; }
        .active { display: block; }
        audio, video { margin: 10px 0; }
        img { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    <h1>Language Flashcard App</h1>

    <section id="import-section">
        <h2>Import JSON Data</h2>
        <textarea id="json-input" rows="10" cols="50" placeholder="Paste your JSON array here..."></textarea>
        <button onclick="importData()">Import</button>
    </section>

    <section id="items-section">
        <h2>All Items</h2>
        <ul id="all-items"></ul>
    </section>

    <section id="groups-section">
        <h2>Groups</h2>
        <input type="text" id="new-group-name" placeholder="New group name">
        <button onclick="createGroup()">Create Group</button>
        <div id="groups-container"></div>
    </section>

    <section id="learning-section">
        <h2>Learn a Group</h2>
        <select id="group-select"></select>
        <select id="mode-select">
            <option value="image">Image</option>
            <option value="chinese">Chinese Characters</option>
            <option value="pinyin">Pinyin</option>
        </select>
        <button onclick="startSession()">Start Session</button>
        <div id="flashcard-container" style="display: none;">
            <div class="flashcard" onclick="flipCard()">
                <div class="front active"></div>
                <div class="back"></div>
            </div>
            <button onclick="markCorrect()">Correct</button>
            <button onclick="markIncorrect()">Incorrect</button>
            <p id="progress"></p>
        </div>
        <div id="session-result" style="display: none;"></div>
    </section>

    <script>
        let allItems = [];
        let groups = {};
        const storageKey = 'flashcardAppData';

        // Load saved data from localStorage
        function loadData() {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                const data = JSON.parse(saved);
                allItems = data.items || [];
                groups = data.groups || {};
                renderAllItems();
                renderGroups();
                populateGroupSelect();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem(storageKey, JSON.stringify({ items: allItems, groups }));
        }

        // Import JSON data
        function importData() {
            const jsonInput = document.getElementById('json-input').value;
            try {
                const imported = JSON.parse(jsonInput);
                allItems = imported.map(item => ({
                    ...item,
                    image: null // Placeholder for user-uploaded image
                }));
                renderAllItems();
                saveData();
                alert('Data imported successfully!');
            } catch (e) {
                alert('Invalid JSON!');
            }
        }

        // Render all items list
        function renderAllItems() {
            const ul = document.getElementById('all-items');
            ul.innerHTML = '';
            allItems.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.source_value} - ${item.target_value}`;
                li.dataset.id = item.learnable_id;

                // Add to group button
                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add to Group';
                addBtn.onclick = () => addToGroupPrompt(item.learnable_id);
                li.appendChild(addBtn);

                // Upload image button
                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.accept = 'image/*';
                uploadInput.onchange = (e) => uploadImage(item.learnable_id, e.target.files[0]);
                li.appendChild(uploadInput);

                ul.appendChild(li);
            });
        }

        // Prompt to add to group
        function addToGroupPrompt(id) {
            const groupName = prompt('Enter group name to add to:');
            if (groupName && groups[groupName]) {
                if (!groups[groupName].includes(id)) {
                    groups[groupName].push(id);
                    renderGroups();
                    saveData();
                }
            } else {
                alert('Group not found!');
            }
        }

        // Upload image for item
        function uploadImage(id, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const item = allItems.find(i => i.learnable_id === id);
                item.image = e.target.result; // Data URL
                saveData();
                alert('Image uploaded!');
            };
            reader.readAsDataURL(file);
        }

        // Create new group
        function createGroup() {
            const name = document.getElementById('new-group-name').value.trim();
            if (name && !groups[name]) {
                groups[name] = [];
                renderGroups();
                saveData();
                populateGroupSelect();
            }
        }

        // Render groups
        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            Object.keys(groups).forEach(name => {
                const div = document.createElement('div');
                div.innerHTML = `<h3>${name}</h3>`;
                const ul = document.createElement('ul');
                ul.id = `group-${name}`;
                ul.classList.add('sortable');

                groups[name].forEach(id => {
                    const item = allItems.find(i => i.learnable_id === id);
                    if (item) {
                        const li = document.createElement('li');
                        li.textContent = `${item.source_value} - ${item.target_value}`;
                        li.dataset.id = id;
                        li.classList.add('group-item');
                        ul.appendChild(li);
                    }
                });

                div.appendChild(ul);

                // Remove group button
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete Group';
                delBtn.onclick = () => {
                    delete groups[name];
                    renderGroups();
                    populateGroupSelect();
                    saveData();
                };
                div.appendChild(delBtn);

                container.appendChild(div);

                // Make sortable for ordering
                makeSortable(ul, name);
            });
        }

        // Make list sortable
        function makeSortable(ul, groupName) {
            ul.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
            });
            ul.addEventListener('dragover', (e) => e.preventDefault());
            ul.addEventListener('drop', (e) => {
                e.preventDefault();
                const id = e.dataTransfer.getData('text/plain');
                const target = e.target.closest('li');
                if (target && target.dataset.id !== id) {
                    const fromIndex = groups[groupName].indexOf(Number(id));
                    const toIndex = groups[groupName].indexOf(Number(target.dataset.id));
                    if (fromIndex !== -1 && toIndex !== -1) {
                        const [moved] = groups[groupName].splice(fromIndex, 1);
                        groups[groupName].splice(toIndex, 0, moved);
                        renderGroups();
                        saveData();
                    }
                }
            });
        }

        // Populate group select for learning
        function populateGroupSelect() {
            const select = document.getElementById('group-select');
            select.innerHTML = '';
            Object.keys(groups).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // Learning session
        let currentSession = {
            items: [],
            mode: '',
            index: 0,
            correct: 0,
            total: 0,
            flipped: false
        };

        function startSession() {
            const groupName = document.getElementById('group-select').value;
            const mode = document.getElementById('mode-select').value;
            if (!groupName || !groups[groupName].length) return alert('No group selected or empty!');

            currentSession.items = groups[groupName].map(id => allItems.find(i => i.learnable_id === id));
            currentSession.mode = mode;
            currentSession.index = 0;
            currentSession.correct = 0;
            currentSession.total = currentSession.items.length;
            currentSession.flipped = false;

            document.getElementById('flashcard-container').style.display = 'block';
            document.getElementById('session-result').style.display = 'none';
            showCard();
        }

        function showCard() {
            if (currentSession.index >= currentSession.total) {
                const percent = (currentSession.correct / currentSession.total) * 100;
                document.getElementById('session-result').innerHTML = `Session complete! Correct: ${currentSession.correct}/${currentSession.total} (${percent.toFixed(2)}%)`;
                document.getElementById('session-result').style.display = 'block';
                document.getElementById('flashcard-container').style.display = 'none';
                return;
            }

            const item = currentSession.items[currentSession.index];
            const front = document.querySelector('.front');
            const back = document.querySelector('.back');

            // Front based on mode
            if (currentSession.mode === 'image' && item.image) {
                front.innerHTML = `<img src="${item.image}" alt="Image">`;
            } else if (currentSession.mode === 'chinese') {
                front.textContent = item.target_value;
            } else if (currentSession.mode === 'pinyin') {
                front.textContent = item.romanization;
            } else {
                front.textContent = 'No image available'; // Fallback
            }

            // Back with all info
            back.innerHTML = `
                <p><strong>Chinese:</strong> ${item.target_value}</p>
                <p><strong>Pinyin:</strong> ${item.romanization}</p>
                <p><strong>English:</strong> ${item.source_value}</p>
                <p><strong>Literal:</strong> ${item.literal_translation || 'N/A'}</p>
                <h4>Audios:</h4>
                ${item.audio_urls.map(url => `<audio controls src="${url}"></audio>`).join('<br>')}
                <h4>Videos:</h4>
                ${item.video_urls.map(url => `<video controls width="200" src="${url}"></video>`).join('<br>')}
            `;

            front.classList.add('active');
            back.classList.remove('active');
            currentSession.flipped = false;

            document.getElementById('progress').textContent = `Card ${currentSession.index + 1}/${currentSession.total}`;
        }

        function flipCard() {
            if (currentSession.flipped) return;
            document.querySelector('.front').classList.remove('active');
            document.querySelector('.back').classList.add('active');
            currentSession.flipped = true;
        }

        function markCorrect() {
            if (!currentSession.flipped) return alert('Flip first!');
            currentSession.correct++;
            nextCard();
        }

        function markIncorrect() {
            if (!currentSession.flipped) return alert('Flip first!');
            nextCard();
        }

        function nextCard() {
            currentSession.index++;
            currentSession.flipped = false;
            showCard();
        }

        // Initial load
        loadData();
    </script>
</body>
</html>